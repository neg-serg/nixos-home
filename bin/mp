#!/usr/bin/env sh
set -eu
if (set -o pipefail) 2>/dev/null; then
  set -o pipefail
fi
# mp: play with mpv and print media info for inputs concurrently
# Usage: mp FILES...
#   Spawns vid-info for provided files/dirs and plays them via mpv.

if [ "${1:-}" = "-h" ] || [ "${1:-}" = "--help" ]; then
  sed -n '2,4p' "$0" | sed 's/^# \{0,1\}//'; exit 0
fi

main() {
    for arg in "$@"; do
        [ -d "$arg" ] && find "$arg" -maxdepth 1 -type f -print0 | xargs -0n10 -P 10 vid-info &
    done
    {
        args=""
        for arg in "$@"; do
            [ -f "$arg" ] && args="$args$(printf '%s' "$arg")";
        done
        command echo -n "$args" | xargs -0n10 -P 10 vid-info
    } &
    mpv --quiet "$@" > "$HOME/tmp/mpv.log"
}

main "$@"
